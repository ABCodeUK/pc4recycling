import{r as l,R as F,j as s,b}from"./app-Cma8V3l9.js";import{T as L,a as M,b as I,c as S}from"./tabs-sJVBdolV.js";import{S as z}from"./separator-CEPuzrhi.js";import{B as _}from"./button-DS1ZOJ9c.js";import{DataTable as B}from"./data-table-Bc6rbH-u.js";import{jobItemColumns as H}from"./columns-DC49rau_.js";import{t as u}from"./index-C_iezvca.js";import V from"./CollectionSignatureDialog-BovADmw7.js";import"./index-jFmiJHnk.js";import"./index-rOaI9F-v.js";import"./index-DHxxav9I.js";import"./index-Cdv8n69u.js";import"./index-CoYLIXTa.js";import"./utils-CytzSlOG.js";import"./index-Dp-u-l4U.js";import"./index-BwobEAja.js";import"./table-vJebbvAp.js";import"./select-DcwlFvdE.js";import"./index-CJRq-bCV.js";import"./index-BUxlmQ7d.js";import"./createLucideIcon-BnM-jrHn.js";import"./index-CrYhDhYK.js";import"./input-_RUYSLpp.js";import"./maximize-2-bAdWuGOe.js";import"./trash-2-DUTB_MOx.js";import"./checkbox-g5XuN9uX.js";import"./extends-CF3RwP-h.js";import"./dialog-C3tgJ_8I.js";import"./index-BH7C-wFc.js";import"./label-IUEK5zVZ.js";function je({jobId:i,jobStatus:N}){const[O,x]=l.useState(!1),[p,g]=l.useState(!1),[a,h]=l.useState([]),[j,J]=l.useState([]),[G,v]=l.useState(!0),[f,C]=l.useState([]),[T,y]=l.useState([]),w=async()=>{if(i){v(!0);try{const[e,t]=await Promise.all([b.get("/api/categories"),b.get(`/api/jobs/${i}/items`)]);J(e.data);const n=t.data.items.filter(r=>!r.deleted_at);h(n),y(JSON.parse(JSON.stringify(n))),C(t.data.existingItemNumbers)}catch(e){console.error("Error fetching data:",e),e instanceof Error&&"response"in e&&console.error("Server error:",e.response.data),u.error("Failed to fetch data")}finally{v(!1)}}},E=()=>{const e=a.filter(o=>o.id!==0),t=T.filter(o=>o.id!==0);if(e.length!==t.length)return!0;const n=[...e].sort((o,d)=>o.item_number.localeCompare(d.item_number)),r=[...t].sort((o,d)=>o.item_number.localeCompare(d.item_number)),c=a.some(o=>o.id===0);return JSON.stringify(n)!==JSON.stringify(r)||c},P=e=>{h(e),setTimeout(()=>{const t=E();g(t)},0)},D=e=>{const t=[],n=e.quantity,r={...e,quantity:1};t.push(r);for(let m=1;m<n;m++){const o=q(),d={...e,id:0,item_number:o,quantity:1};t.push(d),f.push(o)}const c=[...a.filter(m=>m.item_number!==e.item_number),...t];h(c),C([...f]),setTimeout(()=>{const m=E();g(m)},0)},R=()=>{const e=q(),t={id:0,job_id:0,item_number:e,quantity:1,category_id:null,sub_category_id:null,make:null,model:null,erasure_required:null,specification:null,image_path:null,processing_make:null,processing_model:null,processing_specification:null,processing_erasure_required:null,added:"Collection"};h([...a,t]),C([...f,e]),g(!0)},$=async()=>{try{const e=a.map(r=>r.item_number);if(new Set(e).size!==e.length){u.error("Duplicate item numbers found. Please ensure all item numbers are unique.");return}const n=a.map(r=>({...r,job_id:i,make:r.make||null,model:r.model||null,erasure_required:r.erasure_required||null}));console.log("Items being sent to server:",n),await b.post(`/api/jobs/${i}/items`,{items:n}),u.success("Items saved successfully"),g(!1),y(JSON.parse(JSON.stringify(a))),await w()}catch(e){console.error("Error saving items:",e),e instanceof Error&&"response"in e&&console.error("Server error:",e.response.data),u.error("Failed to save items")}},q=()=>{let e=1,t;do t=`${i}-${e.toString().padStart(2,"0")}`,e++;while(f.includes(t));return t},A=F.useMemo(()=>j,[j]);l.useEffect(()=>{i&&w()},[i]);const U=async(e,t,n,r)=>{try{const c={customer_signature:e,customer_name:t,driver_signature:n,driver_name:r};await b.post(`/api/jobs/${i}/mark-collected`,c),u.success("Job marked as collected successfully"),window.location.reload()}catch(c){console.error("Error marking job as collected:",c),u.error("Failed to mark job as collected")}finally{x(!1)}},k=()=>["Needs Scheduling","Request Pending","Scheduled","Postponed"].includes(N);return s.jsxs("section",{className:"bg-white border shadow rounded-lg",children:[s.jsxs("header",{className:"p-6 flex justify-between items-center",children:[s.jsx("h2",{className:"text-lg font-semibold",children:"Collection Items"}),N==="Scheduled"&&s.jsx(_,{onClick:()=>x(!0),disabled:p,title:p?"Please save your changes first":"",children:"Mark Job Collected"})]}),s.jsx(V,{isOpen:O,onClose:()=>x(!1),onComplete:U}),s.jsx(z,{}),s.jsx("div",{className:"p-6",children:s.jsxs(L,{defaultValue:"collection",className:"w-full",children:[s.jsxs(M,{className:"grid w-full grid-cols-3",children:[s.jsx(I,{value:"collection",children:"Collection"}),s.jsx(I,{value:"processing",disabled:!0,children:"Processing"}),s.jsx(I,{value:"completed",disabled:!0,children:"Completed"})]}),s.jsxs(S,{value:"collection",className:"mt-6",children:[s.jsx(B,{columns:H,data:a,meta:{categories:A,setItems:P,onExpandItem:D,isEditable:k()}}),k()&&s.jsxs("div",{className:"flex justify-between mt-4",children:[s.jsx(_,{onClick:R,children:"Add Item"}),s.jsx(_,{onClick:$,disabled:!p,title:p?"":"No changes to save",children:"Save Changes"})]})]}),s.jsx(S,{value:"processing",children:s.jsx("p",{children:"Items in processing"})}),s.jsx(S,{value:"completed",children:s.jsx("p",{children:"Completed items"})})]})})]})}export{je as default};
