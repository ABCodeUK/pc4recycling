import{r as i,j as t,V as S,R as T,b as u}from"./app-DUv4C8zR.js";import{B as m}from"./button-ByXYoKeZ.js";import{c as A}from"./utils-CytzSlOG.js";import{S as C}from"./separator-52U-weNF.js";import{t as r}from"./index-DfymCQFU.js";import{B}from"./badge-CBKa4bKq.js";import{P as L}from"./pencil-BOaC6laL.js";import{T as _}from"./trash-2-DBI7At-f.js";import"./index-Lcj1GtjH.js";import"./index-BwobEAja.js";import"./index-XC-7eegb.js";import"./index-DeR6T8Ux.js";import"./createLucideIcon-D1MVXgdA.js";const N=i.forwardRef(({className:s,...o},p)=>t.jsx("textarea",{className:A("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),ref:p,...o}));N.displayName="Textarea";function K({jobId:s}){const{auth:o}=S().props,[p,j]=i.useState([]),[n,l]=i.useState(""),[w,g]=i.useState(!1),[c,f]=i.useState(null),d=T.useRef(null),h=()=>{d.current&&(d.current.scrollTop=d.current.scrollHeight)},x=async()=>{try{const e=await u.get(`/api/jobs/${s}/audit`);j(e.data.sort((a,E)=>new Date(a.created_at).getTime()-new Date(E.created_at).getTime())),setTimeout(h,100)}catch(e){console.error("Error fetching audit log:",e),r.error("Failed to load audit log")}},b=async()=>{if(n.trim()){g(!0);try{c?(await u.put(`/api/jobs/${s}/audit/${c}`,{content:n}),r.success("Note updated successfully")):(await u.post(`/api/jobs/${s}/audit`,{content:n}),r.success("Note added successfully")),l(""),f(null),await x(),setTimeout(h,100)}catch(e){console.error("Error saving note:",e),r.error("Failed to save note")}finally{g(!1)}}},v=e=>{l(e.content),f(e.id)},y=async e=>{if(confirm("Are you sure you want to delete this note?"))try{await u.delete(`/api/jobs/${s}/audit/${e}`),await x(),r.success("Note deleted successfully")}catch(a){console.error("Error deleting note:",a),r.error("Failed to delete note")}};return i.useEffect(()=>{x()},[s]),t.jsxs("section",{className:"bg-white border shadow rounded-lg p-6",children:[t.jsx("h2",{className:"text-xl font-semibold leading-7 text-gray-900",children:"Job Audit Log"}),t.jsx(C,{className:"my-4"}),t.jsx("div",{ref:d,className:"space-y-4 mb-4 max-h-[300px] overflow-y-auto",children:p.map(e=>{var a;return t.jsx("div",{className:"bg-gray-50 p-4 rounded-lg",children:t.jsxs("div",{className:"flex justify-between items-start",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"flex items-center gap-2",children:t.jsx("div",{className:"text-sm text-gray-900",children:e.content})}),t.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[new Date(e.created_at).toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"numeric",minute:"2-digit",hour12:!0}).replace(" pm","PM").replace(" am","AM")," by ",e.staff.name,e.updated_at!==e.created_at&&t.jsxs("span",{className:"ml-2 text-gray-400",children:["(edited ",new Date(e.updated_at).toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"numeric",minute:"2-digit",hour12:!0}).replace(" pm","PM").replace(" am","AM"),")"]})]})]}),t.jsx("div",{className:"flex gap-2 ml-4",children:e.is_system==="true"?t.jsx(B,{variant:"secondary",children:"System"}):e.staff.id===((a=o==null?void 0:o.user)==null?void 0:a.id)&&t.jsxs(t.Fragment,{children:[t.jsx(m,{variant:"ghost",size:"icon",onClick:()=>v(e),children:t.jsx(L,{className:"h-4 w-4"})}),t.jsx(m,{variant:"ghost",size:"icon",onClick:()=>y(e.id),children:t.jsx(_,{className:"h-4 w-4 text-red-500"})})]})})]})},e.id)})}),t.jsxs("div",{className:"space-y-4",children:[t.jsx(N,{placeholder:"Enter your update...",className:"min-h-[60px]",value:n,onChange:e=>l(e.target.value),rows:2}),t.jsx(m,{className:"w-full",onClick:b,disabled:w||!n.trim(),children:c?"Save Changes":"Add Note"}),c&&t.jsx(m,{variant:"outline",className:"w-full mt-2",onClick:()=>{f(null),l("")},children:"Cancel Edit"})]})]})}export{K as default};
