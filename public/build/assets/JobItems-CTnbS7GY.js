import{r as a,R as V,j as s,b as I}from"./app-DUv4C8zR.js";import{T as z,a as B,b as N,c as v}from"./tabs-Cx5nvXT-.js";import{S as F}from"./separator-52U-weNF.js";import{B as p}from"./button-ByXYoKeZ.js";import{DataTable as A}from"./data-table-C76lZV4x.js";import{jobItemColumns as M}from"./columns-Jsfa6XZI.js";import{t as x}from"./index-DfymCQFU.js";import{processingColumns as H}from"./processing-columns-D5cl_3qW.js";import"./index-Bi2U6H-I.js";import"./index-Lcj1GtjH.js";import"./index-DeR6T8Ux.js";import"./index-5RnjzhFd.js";import"./utils-CytzSlOG.js";import"./index-XC-7eegb.js";import"./index-BwobEAja.js";import"./table-BXRjnKkf.js";import"./select-Cce2oJH8.js";import"./index-CAh_ZuFR.js";import"./index-Ct7uzItS.js";import"./createLucideIcon-D1MVXgdA.js";import"./index-D1LanMWQ.js";import"./input-ER8UZmlu.js";import"./maximize-2-D5P1B557.js";import"./trash-2-DBI7At-f.js";function Ce({jobId:l,jobStatus:c}){const[G,R]=a.useState(!1),[m,h]=a.useState(!1),[d,D]=a.useState("processing"),[i,f]=a.useState([]),[S,U]=a.useState([]),[K,j]=a.useState(!0),[b,C]=a.useState([]),[$,y]=a.useState([]),w=async()=>{if(l){j(!0);try{const[e,t]=await Promise.all([I.get("/api/categories"),I.get(`/api/jobs/${l}/items`)]);U(e.data);const o=t.data.items.filter(r=>!r.deleted_at);f(o),y(JSON.parse(JSON.stringify(o))),C(t.data.existingItemNumbers)}catch(e){console.error("Error fetching data:",e),e instanceof Error&&"response"in e&&console.error("Server error:",e.response.data),x.error("Failed to fetch data")}finally{j(!1)}}},L=()=>{const e=i.filter(n=>n.id!==0),t=$.filter(n=>n.id!==0);if(e.length!==t.length)return!0;const o=[...e].sort((n,g)=>n.item_number.localeCompare(g.item_number)),r=[...t].sort((n,g)=>n.item_number.localeCompare(g.item_number)),_=i.some(n=>n.id===0);return JSON.stringify(o)!==JSON.stringify(r)||_},E=e=>{f(e),setTimeout(()=>{const t=L();h(t)},0)},P=e=>{const t=[],o=e.quantity,r={...e,quantity:1};t.push(r);for(let u=1;u<o;u++){const n=T(),g={...e,id:0,item_number:n,quantity:1,added:d==="processing"?"Processing":"Collection",original_item_number:e.item_number};t.push(g),b.push(n)}const _=[...i.filter(u=>u.item_number!==e.item_number),...t];f(_),C([...b]),h(!0)},q=()=>{const e=T(),t={id:0,job_id:0,item_number:e,quantity:1,category_id:null,sub_category_id:null,make:null,model:null,erasure_required:null,processing_data_status:null,specification:null,image_path:null,processing_make:null,processing_model:null,processing_specification:null,processing_erasure_required:null,serial_number:null,asset_tag:null,added:d==="processing"?"Processing":"Collection"};f([...i,t]),C([...b,e]),h(!0)},O=async()=>{try{const e=i.map(r=>r.item_number);if(new Set(e).size!==e.length){x.error("Duplicate item numbers found. Please ensure all item numbers are unique.");return}const o=i.map(r=>({...r,job_id:l,added:r.id===0?d==="processing"?"Processing":"Collection":r.added||"Collection",make:r.make||null,model:r.model||null,erasure_required:r.erasure_required||null}));await I.post(`/api/jobs/${l}/items`,{items:o}),x.success("Items saved successfully"),h(!1),y(JSON.parse(JSON.stringify(i))),await w()}catch(e){console.error("Error saving items:",e),e instanceof Error&&"response"in e&&console.error("Server error:",e.response.data),x.error("Failed to save items")}},T=()=>{let e=1,t;do t=`${l}-${e.toString().padStart(2,"0")}`,e++;while(b.includes(t));return t},k=V.useMemo(()=>S,[S]);a.useEffect(()=>{l&&w()},[l]);const J=()=>["Needs Scheduling","Request Pending","Scheduled","Postponed"].includes(c);return s.jsxs("section",{className:"bg-white border shadow rounded-lg",children:[s.jsxs("header",{className:"p-6 flex justify-between items-center",children:[s.jsx("h2",{className:"text-lg font-semibold",children:"Processing Items"}),c==="Scheduled"&&s.jsx(p,{onClick:()=>R(!0),disabled:m,title:m?"Please save your changes first":"",children:"Mark Job Collected"})]}),s.jsx(F,{}),s.jsx("div",{className:"p-6",children:s.jsxs(z,{value:d,defaultValue:"processing",className:"w-full",onValueChange:D,children:[s.jsxs(B,{className:"grid w-full grid-cols-3",children:[s.jsx(N,{value:"collection",children:"Collection"}),s.jsx(N,{value:"processing",children:"Processing"}),s.jsx(N,{value:"completed",disabled:!0,children:"Completed"})]}),s.jsxs(v,{value:"collection",className:"mt-6",children:[s.jsx(A,{columns:M,data:i.filter(e=>e.added==="Collection"&&!e.original_item_number),meta:{categories:k,setItems:E,onExpandItem:P,isEditable:J()}}),J()&&s.jsxs("div",{className:"flex justify-between mt-4",children:[s.jsx(p,{onClick:q,children:"Add Item"}),s.jsx(p,{onClick:O,disabled:!m,title:m?"":"No changes to save",children:"Save Changes"})]})]}),s.jsxs(v,{value:"processing",className:"mt-6",children:[s.jsx(A,{columns:H,data:i.filter(e=>["Collection","Processing"].includes(e.added||"")||e.id===0&&d==="processing"),meta:{categories:k,setItems:E,onExpandItem:P,isEditable:["Collected","Processing"].includes(c),jobStatus:c},columnVisibility:{processing_data_status:["Processing","Completed"].includes(c)}}),["Collected","Processing"].includes(c)&&s.jsxs("div",{className:"flex justify-between mt-4",children:[s.jsx(p,{onClick:q,children:"Add Item"}),s.jsx(p,{onClick:O,disabled:!m,title:m?"":"No changes to save",children:"Save Changes"})]})]}),s.jsx(v,{value:"completed",children:s.jsx("p",{children:"Completed items"})})]})})]})}export{Ce as default};
