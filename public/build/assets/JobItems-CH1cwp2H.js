import{r as l,R as B,j as t,b as g}from"./app-BB65Mc1n.js";import{T as V,a as H,b as S,c as y}from"./tabs-D_Qtma4o.js";import{S as G}from"./separator-BWJbAkR8.js";import{B as x}from"./button-AMd0rht4.js";import{DataTable as K}from"./data-table-CL_gPgFc.js";import{jobItemColumns as Q}from"./columns-KDOPKmxR.js";import{t as m}from"./index-BD8g9cTJ.js";import W from"./ReceivedSignatureDialog-Qc4VxU4G.js";import X from"./CollectionSignatureDialog-CFKPwqw2.js";import"./index-DJRbUwlk.js";import"./index-CwOflKzf.js";import"./index-BD0Aflgb.js";import"./index--1ygw0mz.js";import"./index-DwCxHBl2.js";import"./utils-CytzSlOG.js";import"./index-C6WAMNeG.js";import"./index-BwobEAja.js";import"./table-Baebw86p.js";import"./select-Dp5Udnaz.js";import"./index-d89-VRCp.js";import"./index-C6DuYNlM.js";import"./createLucideIcon-DhOTYlCm.js";import"./index-Bax49BpN.js";import"./index-DbDOfuCE.js";import"./input-BdsrUm4j.js";import"./maximize-2-IQ1HLsfM.js";import"./trash-2-CyBVRyGm.js";import"./checkbox-Bc7cJ-Jo.js";import"./extends-CF3RwP-h.js";import"./dialog-44kL--cs.js";import"./label-B29Fbpt8.js";function Oe({jobId:n,jobStatus:_,job:N}){const[R,v]=l.useState(!1),[T,C]=l.useState(!1),[d,h]=l.useState(!1),[c,f]=l.useState([]),[j,D]=l.useState([]),[Y,w]=l.useState(!0),[b,I]=l.useState([]),[P,k]=l.useState([]),E=async()=>{if(n){w(!0);try{const[e,s]=await Promise.all([g.get("/api/categories"),g.get(`/api/jobs/${n}/items`)]);D(e.data);const o=s.data.items.filter(r=>!r.deleted_at).filter(r=>r.added==="Collection"||!r.added);f(o),k(JSON.parse(JSON.stringify(o))),I(s.data.existingItemNumbers)}catch(e){console.error("Error fetching data:",e),e instanceof Error&&"response"in e&&console.error("Server error:",e.response.data),m.error("Failed to fetch data")}finally{w(!1)}}},O=()=>{const e=c.filter(a=>a.id!==0),s=P.filter(a=>a.id!==0);if(e.length!==s.length)return!0;const o=[...e].sort((a,p)=>a.item_number.localeCompare(p.item_number)),r=[...s].sort((a,p)=>a.item_number.localeCompare(p.item_number)),u=c.some(a=>a.id===0);return JSON.stringify(o)!==JSON.stringify(r)||u},$=e=>{f(e),setTimeout(()=>{const s=O();h(s)},0)},M=e=>{const s=[],o=e.quantity,r={...e,quantity:1};s.push(r);for(let i=1;i<o;i++){const a=q(),p={...e,id:0,item_number:a,quantity:1};s.push(p),b.push(a)}const u=[...c.filter(i=>i.item_number!==e.item_number),...s];f(u),I([...b]),setTimeout(()=>{const i=O();h(i)},0)},A=()=>{const e=q(),s={id:0,job_id:0,item_number:e,quantity:1,category_id:null,sub_category_id:null,make:null,model:null,serial_number:null,weight:null,asset_tag:null,erasure_required:null,specification:null,image_path:null,processing_make:null,processing_model:null,processing_serial_number:null,processing_asset_tag:null,processing_weight:null,processing_specification:null,processing_erasure_required:null,added:"Collection"};f([...c,s]),I([...b,e]),h(!0)},F=async()=>{try{const e=c.map(r=>r.item_number);if(new Set(e).size!==e.length){m.error("Duplicate item numbers found. Please ensure all item numbers are unique.");return}const o=c.map(r=>({...r,job_id:n,make:r.make||null,model:r.model||null,erasure_required:r.erasure_required||null}));console.log("Items being sent to server:",o),await g.post(`/api/jobs/${n}/items`,{items:o}),m.success("Items saved successfully"),h(!1),k(JSON.parse(JSON.stringify(c))),await E()}catch(e){console.error("Error saving items:",e),e instanceof Error&&"response"in e&&console.error("Server error:",e.response.data),m.error("Failed to save items")}},q=()=>{let e=1,s;do s=`${n}-${e.toString().padStart(2,"0")}`,e++;while(b.includes(s));return s},U=B.useMemo(()=>j,[j]);l.useEffect(()=>{n&&E()},[n]);const L=async(e,s,o,r,u)=>{try{const i={customer_signature:e,customer_name:s,driver_signature:o,driver_name:r,vehicle:u};await g.post(`/api/jobs/${n}/mark-collected`,i),m.success("Job marked as collected successfully"),window.location.reload()}catch(i){console.error("Error marking job as collected:",i),m.error("Failed to mark job as collected")}finally{v(!1)}},z=async(e,s,o)=>{try{const r={staffSignature:e,staffName:s,receivedDate:o};await g.post(`/api/jobs/${n}/mark-received`,r),m.success("Job marked as received successfully"),window.location.reload()}catch(r){console.error("Error marking job as received:",r),m.error("Failed to mark job as received")}finally{C(!1)}},J=()=>["Needs Scheduling","Request Pending","Scheduled","Postponed"].includes(_);return t.jsxs("section",{className:"bg-white border shadow rounded-lg",children:[t.jsxs("header",{className:"p-6 flex justify-between items-center",children:[t.jsx("h2",{className:"text-lg font-semibold",children:"Collection Items"}),_==="Scheduled"&&t.jsx(x,{onClick:()=>v(!0),disabled:d,title:d?"Please save your changes first":"",children:"Mark Job as Collected"}),_==="Collected"&&t.jsx(x,{onClick:()=>C(!0),disabled:d,title:d?"Please save your changes first":"",children:"Mark Job as Received"})]}),t.jsx(X,{isOpen:R,onClose:()=>v(!1),onComplete:L,defaultVehicle:N.vehicle,defaultCustomerName:N.onsite_contact}),t.jsx(W,{isOpen:T,onClose:()=>C(!1),onComplete:z}),t.jsx(G,{}),t.jsx("div",{className:"p-6",children:t.jsxs(V,{defaultValue:"collection",className:"w-full",children:[t.jsxs(H,{className:"grid w-full grid-cols-3",children:[t.jsx(S,{value:"collection",children:"Collection"}),t.jsx(S,{value:"processing",disabled:!0,children:"Processing"}),t.jsx(S,{value:"completed",disabled:!0,children:"Completed"})]}),t.jsxs(y,{value:"collection",className:"mt-6",children:[t.jsx(K,{columns:Q,data:c,meta:{categories:U,setItems:$,onExpandItem:M,isEditable:J()}}),J()&&t.jsxs("div",{className:"flex justify-between mt-4",children:[t.jsx(x,{onClick:A,children:"Add Item"}),t.jsx(x,{onClick:F,disabled:!d,title:d?"":"No changes to save",children:"Save Items"})]})]}),t.jsx(y,{value:"processing",children:t.jsx("p",{children:"Items in processing"})}),t.jsx(y,{value:"completed",children:t.jsx("p",{children:"Completed items"})})]})})]})}export{Oe as default};
