import{r as c,R as M,j as t,b as I}from"./app-BB65Mc1n.js";import{T as V,a as H,b as N,c as v}from"./tabs-D_Qtma4o.js";import{S as G}from"./separator-BWJbAkR8.js";import{B as A}from"./button-AMd0rht4.js";import{DataTable as K}from"./data-table-tQ-UeZMJ.js";import{jobItemColumns as W}from"./columns-CjI3qSIB.js";import{t as h}from"./index-BD8g9cTJ.js";import"./index-DJRbUwlk.js";import"./index-CwOflKzf.js";import"./index-BD0Aflgb.js";import"./index--1ygw0mz.js";import"./index-DwCxHBl2.js";import"./utils-CytzSlOG.js";import"./index-C6WAMNeG.js";import"./index-BwobEAja.js";import"./table-Baebw86p.js";import"./select-Dp5Udnaz.js";import"./index-d89-VRCp.js";import"./index-C6DuYNlM.js";import"./createLucideIcon-DhOTYlCm.js";import"./index-Bax49BpN.js";import"./index-DbDOfuCE.js";import"./input-BdsrUm4j.js";import"./maximize-2-IQ1HLsfM.js";import"./trash-2-CyBVRyGm.js";function we({jobId:i,jobStatus:a,job:X}){const C=["Quote Draft","Quote Requested","Quote Provided","Quote Rejected","Needs Scheduling","Request Pending","Scheduled","Postponed","Collected"],J=["Received at Facility","Processing"],f=["Complete"],w=()=>C.includes(a)?"collection":J.includes(a)?"processing":f.includes(a)?"completed":"collection",k=()=>({collection:!0,processing:!C.includes(a)||f.includes(a),completed:f.includes(a)}),[y,d]=c.useState(!1),[b,Q]=c.useState(w()),[o,p]=c.useState([]),[S,D]=c.useState([]),[Y,j]=c.useState(!0),[g,_]=c.useState([]),[U,q]=c.useState([]),T=k(),P=async()=>{if(i){j(!0);try{const[e,s]=await Promise.all([I.get("/api/categories"),I.get(`/api/jobs/${i}/items`)]);D(e.data);const l=s.data.items.filter(n=>!n.deleted_at);p(l),q(JSON.parse(JSON.stringify(l))),_(s.data.existingItemNumbers)}catch(e){console.error("Error fetching data:",e),e instanceof Error&&"response"in e&&console.error("Server error:",e.response.data),h.error("Failed to fetch data")}finally{j(!1)}}},E=()=>{const e=o.filter(r=>r.id!==0),s=U.filter(r=>r.id!==0);if(e.length!==s.length)return!0;const l=[...e].sort((r,u)=>r.item_number.localeCompare(u.item_number)),n=[...s].sort((r,u)=>r.item_number.localeCompare(u.item_number)),x=o.some(r=>r.id===0);return JSON.stringify(l)!==JSON.stringify(n)||x},$=e=>{p(e),setTimeout(()=>{const s=E();d(s)},0)},B=e=>{const s=[],l=e.quantity,n={...e,quantity:1};s.push(n);for(let m=1;m<l;m++){const r=R(),u={...e,id:0,item_number:r,quantity:1};s.push(u),g.push(r)}const x=[...o.filter(m=>m.item_number!==e.item_number),...s];p(x),_([...g]),setTimeout(()=>{const m=E();d(m)},0)},F=()=>{const e=R(),s={id:0,job_id:parseInt(i),item_number:e,quantity:1,category_id:null,sub_category_id:null,make:null,model:null,serial_number:null,weight:null,asset_tag:null,image_path:null,erasure_required:null,specification:null,processing_make:null,processing_model:null,processing_serial_number:null,processing_asset_tag:null,processing_weight:null,processing_specification:null,processing_erasure_required:null,processing_data_status:null,item_status:null,added:b==="processing"?"Processing":"Collection"};p([...o,s]),_([...g,e]),d(!0)},R=()=>{let e=1,s;do s=`${i}-${e.toString().padStart(2,"0")}`,e++;while(g.includes(s));return s},L=async()=>{try{const e=o.map(n=>n.item_number);if(new Set(e).size!==e.length){h.error("Duplicate item numbers found. Please ensure all item numbers are unique.");return}const l=o.map(n=>({...n,job_id:i,added:n.added||(b==="processing"?"Processing":"Collection"),processing_data_status:n.processing_data_status||null,item_status:n.item_status||null,make:n.make||null,model:n.model||null,weight:n.weight||null,erasure_required:n.erasure_required||null}));await I.post(`/api/jobs/${i}/items`,{items:l}),h.success("Items saved successfully"),d(!1),q(JSON.parse(JSON.stringify(o))),await P()}catch(e){console.error("Error saving items:",e),h.error("Failed to save items")}},z=M.useMemo(()=>S,[S]);c.useEffect(()=>{i&&P()},[i]);const O=a==="Quote Requested"||a==="Quote Draft";return t.jsxs("section",{className:"bg-white border shadow rounded-lg",children:[t.jsx("header",{className:"p-6 flex justify-between items-center",children:t.jsx("h2",{className:"text-lg font-semibold",children:"Collection Items"})}),t.jsx(G,{}),t.jsx("div",{className:"p-6",children:t.jsxs(V,{value:b,defaultValue:w(),className:"w-full",onValueChange:Q,children:[t.jsxs(H,{className:"grid w-full grid-cols-3",children:[t.jsx(N,{value:"collection",children:"Collection"}),t.jsx(N,{value:"processing",disabled:!T.processing,children:"Processing"}),t.jsx(N,{value:"completed",disabled:!T.completed,children:"Completed"})]}),t.jsxs(v,{value:"collection",className:"mt-6",children:[t.jsx(K,{columns:W,data:o.filter(e=>e.added==="Collection"&&!e.original_item_number),meta:{categories:z,setItems:$,onExpandItem:B,isEditable:O}}),O&&t.jsxs("div",{className:"flex justify-between mt-4",children:[t.jsx(A,{onClick:F,children:"Add Item"}),t.jsx(A,{onClick:L,disabled:!y,title:y?"":"No changes to save",children:"Save Items"})]})]}),t.jsx(v,{value:"processing",className:"mt-6",children:t.jsx("div",{className:"p-6 text-center text-gray-500",children:t.jsx("p",{children:"Processing information will be available after quote acceptance."})})}),t.jsx(v,{value:"completed",className:"mt-6",children:t.jsx("div",{className:"p-6 text-center text-gray-500",children:t.jsx("p",{children:"Completion information will be available when the job is finished."})})})]})})]})}export{we as default};
