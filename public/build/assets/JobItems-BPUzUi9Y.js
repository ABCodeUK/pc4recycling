import{r as c,R as H,j as s,b as p}from"./app-Cma8V3l9.js";import{T as G,a as K,b as _,c as j}from"./tabs-sJVBdolV.js";import{S as Q}from"./separator-CEPuzrhi.js";import{B as u}from"./button-DS1ZOJ9c.js";import{DataTable as T}from"./data-table-BmpMcQ9H.js";import{jobItemColumns as W}from"./columns-CqB_CpVi.js";import{t as a}from"./index-C_iezvca.js";import{processingColumns as X}from"./processing-columns-B_bi78f-.js";import Y from"./ReceivedSignatureDialog-jCj1NE8z.js";import{c as Z}from"./createLucideIcon-BnM-jrHn.js";import"./index-jFmiJHnk.js";import"./index-rOaI9F-v.js";import"./index-DHxxav9I.js";import"./index-Cdv8n69u.js";import"./index-CoYLIXTa.js";import"./utils-CytzSlOG.js";import"./index-Dp-u-l4U.js";import"./index-BwobEAja.js";import"./table-vJebbvAp.js";import"./select-DcwlFvdE.js";import"./index-CJRq-bCV.js";import"./index-BUxlmQ7d.js";import"./index-CrYhDhYK.js";import"./input-_RUYSLpp.js";import"./maximize-2-bAdWuGOe.js";import"./trash-2-DUTB_MOx.js";import"./checkbox-g5XuN9uX.js";import"./extends-CF3RwP-h.js";import"./dialog-C3tgJ_8I.js";import"./index-BH7C-wFc.js";import"./label-IUEK5zVZ.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=Z("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);function Re({jobId:n,jobStatus:m}){const[A,C]=c.useState(!1);c.useState(!1);const[i,b]=c.useState(!1),[g,$]=c.useState("processing"),[d,v]=c.useState([]),[w,D]=c.useState([]),[se,N]=c.useState(!0),[x,y]=c.useState([]),[F,I]=c.useState([]),S=async()=>{if(n){N(!0);try{const[e,t]=await Promise.all([p.get("/api/categories"),p.get(`/api/jobs/${n}/items`)]);D(e.data);const l=t.data.items.filter(r=>!r.deleted_at);v(l),I(JSON.parse(JSON.stringify(l))),y(t.data.existingItemNumbers)}catch(e){console.error("Error fetching data:",e),e instanceof Error&&"response"in e&&console.error("Server error:",e.response.data),a.error("Failed to fetch data")}finally{N(!1)}}},L=()=>{const e=d.filter(o=>o.id!==0),t=F.filter(o=>o.id!==0);if(e.length!==t.length)return!0;const l=[...e].sort((o,f)=>o.item_number.localeCompare(f.item_number)),r=[...t].sort((o,f)=>o.item_number.localeCompare(f.item_number)),k=d.some(o=>o.id===0);return JSON.stringify(l)!==JSON.stringify(r)||k},P=e=>{v(e),setTimeout(()=>{const t=L();b(t)},0)},E=e=>{const t=[],l=e.quantity,r={...e,quantity:1};t.push(r);for(let h=1;h<l;h++){const o=R(),f={...e,id:0,item_number:o,quantity:1,added:g==="processing"?"Processing":"Collection",original_item_number:e.item_number};t.push(f),x.push(o)}const k=[...d.filter(h=>h.item_number!==e.item_number),...t];v(k),y([...x]),b(!0)},J=()=>{const e=R(),t={id:0,job_id:0,item_number:e,quantity:1,category_id:null,sub_category_id:null,make:null,model:null,erasure_required:null,processing_data_status:null,specification:null,image_path:null,processing_make:null,processing_model:null,processing_specification:null,processing_erasure_required:null,serial_number:null,asset_tag:null,added:g==="processing"?"Processing":"Collection"};v([...d,t]),y([...x,e]),b(!0)},q=async()=>{try{const e=d.map(r=>r.item_number);if(new Set(e).size!==e.length){a.error("Duplicate item numbers found. Please ensure all item numbers are unique.");return}const l=d.map(r=>({...r,job_id:n,added:r.id===0?g==="processing"?"Processing":"Collection":r.added||"Collection",make:r.make||null,model:r.model||null,erasure_required:r.erasure_required||null}));await p.post(`/api/jobs/${n}/items`,{items:l}),a.success("Items saved successfully"),b(!1),I(JSON.parse(JSON.stringify(d))),await S()}catch(e){console.error("Error saving items:",e),e instanceof Error&&"response"in e&&console.error("Server error:",e.response.data),a.error("Failed to save items")}},R=()=>{let e=1,t;do t=`${n}-${e.toString().padStart(2,"0")}`,e++;while(x.includes(t));return t},O=H.useMemo(()=>w,[w]);c.useEffect(()=>{n&&S()},[n]);const M=()=>["Needs Scheduling","Request Pending","Scheduled","Postponed"].includes(m),U=async(e,t,l)=>{try{const r={staffSignature:e,staffName:t,receivedDate:l};await p.post(`/api/jobs/${n}/mark-received`,r),a.success("Job marked as received successfully"),window.location.reload()}catch(r){console.error("Error marking job as received:",r),a.error("Failed to mark job as received")}finally{C(!1)}},V=async()=>{try{await p.post(`/api/jobs/${n}/mark-processing`),a.success("Job marked as processing successfully"),window.location.reload()}catch(e){console.error("Error marking job as processing:",e),a.error("Failed to mark job as processing")}},z=async()=>{try{await p.post(`/api/jobs/${n}/mark-completed`),a.success("Job marked as completed successfully"),window.location.reload()}catch(e){console.error("Error marking job as completed:",e),a.error("Failed to mark job as completed")}},B=async()=>{a.info("Aitken sync functionality coming soon")};return s.jsxs("section",{className:"bg-white border shadow rounded-lg",children:[s.jsxs("header",{className:"p-6 flex justify-between items-center",children:[s.jsx("h2",{className:"text-lg font-semibold",children:"Processing Items"}),m==="Processing"&&s.jsxs("div",{className:"flex gap-2",children:[s.jsxs(u,{onClick:B,variant:"outline",disabled:i,title:i?"Please save your changes first":"",children:[s.jsx(ee,{className:"mr-2 h-4 w-4"}),"Sync Aitken"]}),s.jsx(u,{onClick:z,disabled:i,title:i?"Please save your changes first":"",children:"Mark Job Complete"})]}),m==="Received at Facility"&&s.jsx(u,{onClick:V,disabled:i,title:i?"Please save your changes first":"",children:"Mark Job Processing"}),m==="Collected"&&s.jsx(u,{onClick:()=>C(!0),disabled:i,title:i?"Please save your changes first":"",children:"Mark Job Received"})]}),s.jsx(Y,{isOpen:A,onClose:()=>C(!1),onComplete:U}),s.jsx(Q,{}),s.jsx("div",{className:"p-6",children:s.jsxs(G,{value:g,defaultValue:"processing",className:"w-full",onValueChange:$,children:[s.jsxs(K,{className:"grid w-full grid-cols-3",children:[s.jsx(_,{value:"collection",children:"Collection"}),s.jsx(_,{value:"processing",children:"Processing"}),s.jsx(_,{value:"completed",disabled:!0,children:"Completed"})]}),s.jsxs(j,{value:"collection",className:"mt-6",children:[s.jsx(T,{columns:W,data:d.filter(e=>e.added==="Collection"&&!e.original_item_number),meta:{categories:O,setItems:P,onExpandItem:E,isEditable:M()}}),M()&&s.jsxs("div",{className:"flex justify-between mt-4",children:[s.jsx(u,{onClick:J,children:"Add Item"}),s.jsx(u,{onClick:q,disabled:!i,title:i?"":"No changes to save",children:"Save Changes"})]})]}),s.jsxs(j,{value:"processing",className:"mt-6",children:[s.jsx(T,{columns:X,data:d.filter(e=>["Collection","Processing"].includes(e.added||"")||e.id===0&&g==="processing"),meta:{categories:O,setItems:P,onExpandItem:E,isEditable:["Collected","Processing"].includes(m),jobStatus:m},columnVisibility:{processing_data_status:["Processing","Completed"].includes(m)}}),["Collected","Processing"].includes(m)&&s.jsxs("div",{className:"flex justify-between mt-4",children:[s.jsx(u,{onClick:J,children:"Add Item"}),s.jsx(u,{onClick:q,disabled:!i,title:i?"":"No changes to save",children:"Save Changes"})]})]}),s.jsx(j,{value:"completed",children:s.jsx("p",{children:"Completed items"})})]})})]})}export{Re as default};
