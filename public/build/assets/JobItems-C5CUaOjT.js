import{r as m,R as V,j as s,b as f}from"./app-CNWjOMNx.js";import{T as z,a as B,b as v,c as w}from"./tabs-plg5bBI7.js";import{S as H}from"./separator-BPue9knr.js";import{B as u}from"./button-Cif8vmUM.js";import{DataTable as O}from"./data-table-BhmYTfvA.js";import{jobItemColumns as G}from"./columns-Cik7-og2.js";import{t as l}from"./index-DROTMuiR.js";import{processingColumns as K}from"./processing-columns-BFhuZRdD.js";import{c as Q}from"./createLucideIcon-ClQ1hqbp.js";import"./index-D-4-NTWd.js";import"./index-DPKFiV9N.js";import"./index-DUDCROMg.js";import"./index-BqYSSVB3.js";import"./index-BJMVI5o3.js";import"./utils-CytzSlOG.js";import"./index-BHpFse_T.js";import"./index-BwobEAja.js";import"./table-B5rCecqS.js";import"./select-DyBRev3z.js";import"./index-CmDO7QdU.js";import"./index-CNsmnkFI.js";import"./index-CnljWFNF.js";import"./index-BflIAMo0.js";import"./input-CKARXW-H.js";import"./maximize-2-U-dT6VrO.js";import"./trash-2-UOQr6mTH.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const W=Q("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);function Ie({jobId:a,jobStatus:d}){const[i,b]=m.useState(!1),[p,R]=m.useState("processing"),[o,_]=m.useState([]),[I,M]=m.useState([]),[X,N]=m.useState(!0),[x,y]=m.useState([]),[L,k]=m.useState([]),j=async()=>{if(a){N(!0);try{const[e,t]=await Promise.all([f.get("/api/categories"),f.get(`/api/jobs/${a}/items`)]);M(e.data);const c=t.data.items.filter(r=>!r.deleted_at);_(c),k(JSON.parse(JSON.stringify(c))),y(t.data.existingItemNumbers)}catch(e){console.error("Error fetching data:",e),e instanceof Error&&"response"in e&&console.error("Server error:",e.response.data),l.error("Failed to fetch data")}finally{N(!1)}}},$=()=>{const e=o.filter(n=>n.id!==0),t=L.filter(n=>n.id!==0);if(e.length!==t.length)return!0;const c=[...e].sort((n,h)=>n.item_number.localeCompare(h.item_number)),r=[...t].sort((n,h)=>n.item_number.localeCompare(h.item_number)),C=o.some(n=>n.id===0);return JSON.stringify(c)!==JSON.stringify(r)||C},S=e=>{_(e),setTimeout(()=>{const t=$();b(t)},0)},P=e=>{const t=[],c=e.quantity,r={...e,quantity:1};t.push(r);for(let g=1;g<c;g++){const n=q(),h={...e,id:0,item_number:n,quantity:1,added:p==="processing"?"Processing":"Collection",original_item_number:e.item_number};t.push(h),x.push(n)}const C=[...o.filter(g=>g.item_number!==e.item_number),...t];_(C),y([...x]),b(!0)},E=()=>{const e=q(),t={id:0,job_id:parseInt(a),item_number:e,quantity:1,category_id:null,sub_category_id:null,make:null,model:null,serial_number:null,weight:null,asset_tag:null,image_path:null,erasure_required:null,specification:null,processing_make:null,processing_model:null,processing_serial_number:null,processing_asset_tag:null,processing_weight:null,processing_specification:null,processing_erasure_required:null,processing_data_status:null,item_status:null,added:p==="processing"?"Processing":"Collection"};_([...o,t]),y([...x,e]),b(!0)},q=()=>{let e=o.length+1,t;do t=`${a}-${e.toString().padStart(2,"0")}`,e++;while(x.includes(t));return t},J=async()=>{try{const e=o.map(r=>r.item_number);if(new Set(e).size!==e.length){l.error("Duplicate item numbers found. Please ensure all item numbers are unique.");return}const c=o.map(r=>({...r,job_id:a,added:r.added||(p==="processing"?"Processing":"Collection"),processing_data_status:r.processing_data_status||null,item_status:r.item_status||null,make:r.make||null,model:r.model||null,erasure_required:r.erasure_required||null}));await f.post(`/api/jobs/${a}/items`,{items:c}),l.success("Items saved successfully"),b(!1),k(JSON.parse(JSON.stringify(o))),await j()}catch(e){console.error("Error saving items:",e),l.error("Failed to save items")}},T=V.useMemo(()=>I,[I]);m.useEffect(()=>{a&&j()},[a]);const A=()=>["Needs Scheduling","Request Pending","Scheduled","Postponed"].includes(d),D=async()=>{try{await f.post(`/api/jobs/${a}/mark-processing`),l.success("Job marked as processing successfully"),window.location.reload()}catch(e){console.error("Error marking job as processing:",e),l.error("Failed to mark job as processing")}},F=async()=>{try{(await f.post(`/api/jobs/${a}/mark-completed`)).data.document?(l.success("Job marked as completed and Data Destruction Certificate generated"),window.location.reload()):(l.success("Job marked as completed successfully"),window.location.reload())}catch(e){console.error("Error marking job as completed:",e),l.error("Failed to mark job as completed")}},U=async()=>{l.info("Aitken sync functionality coming soon")};return s.jsxs("section",{className:"bg-white border shadow rounded-lg",children:[s.jsxs("header",{className:"p-6 flex justify-between items-center",children:[s.jsx("h2",{className:"text-lg font-semibold",children:"Processing Items"}),d==="Processing"&&s.jsxs("div",{className:"flex gap-2",children:[s.jsxs(u,{onClick:U,variant:"outline",disabled:i,title:i?"Please save your changes first":"",children:[s.jsx(W,{className:"mr-2 h-4 w-4"}),"Sync Aitken"]}),s.jsx(u,{onClick:F,disabled:i,title:i?"Please save your changes first":"",children:"Mark Job as Complete"})]}),d==="Received at Facility"&&s.jsx(u,{onClick:D,disabled:i,title:i?"Please save your changes first":"",children:"Start Processing Job"})]}),s.jsx(H,{}),s.jsx("div",{className:"p-6",children:s.jsxs(z,{value:p,defaultValue:"processing",className:"w-full",onValueChange:R,children:[s.jsxs(B,{className:"grid w-full grid-cols-3",children:[s.jsx(v,{value:"collection",children:"Collection"}),s.jsx(v,{value:"processing",children:"Processing"}),s.jsx(v,{value:"completed",disabled:!0,children:"Completed"})]}),s.jsxs(w,{value:"collection",className:"mt-6",children:[s.jsx(O,{columns:G,data:o.filter(e=>e.added==="Collection"&&!e.original_item_number),meta:{categories:T,setItems:S,onExpandItem:P,isEditable:A()}}),A()&&s.jsxs("div",{className:"flex justify-between mt-4",children:[s.jsx(u,{onClick:E,children:"Add Item"}),s.jsx(u,{onClick:J,disabled:!i,title:i?"":"No changes to save",children:"Save Items"})]})]}),s.jsxs(w,{value:"processing",className:"mt-6",children:[s.jsx(O,{columns:K,data:o.filter(e=>["Collection","Processing"].includes(e.added||"")||e.id===0&&p==="processing"),meta:{categories:T,setItems:S,onExpandItem:P,isEditable:["Collected","Processing"].includes(d),jobStatus:d},columnVisibility:{processing_data_status:["Processing","Completed"].includes(d)}}),["Collected","Processing"].includes(d)&&s.jsxs("div",{className:"flex justify-between mt-4",children:[s.jsx(u,{onClick:E,children:"Add Item"}),s.jsx(u,{onClick:J,disabled:!i,title:i?"":"No changes to save",children:"Save Items"})]})]}),s.jsx(w,{value:"completed",children:s.jsx("p",{children:"Completed items"})})]})})]})}export{Ie as default};
