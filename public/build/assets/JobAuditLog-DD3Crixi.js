import{V as E,r as o,R as S,j as t,b as d}from"./app-BB65Mc1n.js";import{B as m}from"./button-AMd0rht4.js";import{T}from"./textarea-DrPmTigR.js";import{S as A}from"./separator-BWJbAkR8.js";import{t as a}from"./index-BD8g9cTJ.js";import{B as C}from"./badge-BdYjlQZJ.js";import{P as B}from"./pencil-Bk0wSqAt.js";import{T as L}from"./trash-2-CyBVRyGm.js";import"./index-CwOflKzf.js";import"./index-BwobEAja.js";import"./utils-CytzSlOG.js";import"./index-C6WAMNeG.js";import"./index-BD0Aflgb.js";import"./createLucideIcon-DhOTYlCm.js";function K({jobId:r}){const{auth:u}=E().props,[f,N]=o.useState([]),[i,c]=o.useState(""),[j,x]=o.useState(!1),[l,p]=o.useState(null),n=S.useRef(null),g=()=>{n.current&&(n.current.scrollTop=n.current.scrollHeight)},h=async()=>{try{const e=await d.get(`/api/jobs/${r}/audit`);N(e.data.sort((s,b)=>new Date(s.created_at).getTime()-new Date(b.created_at).getTime())),setTimeout(g,100)}catch(e){console.error("Error fetching audit log:",e),a.error("Failed to load audit log")}},w=async()=>{if(i.trim()){x(!0);try{l?(await d.put(`/api/jobs/${r}/audit/${l}`,{content:i}),a.success("Note updated successfully")):(await d.post(`/api/jobs/${r}/audit`,{content:i}),a.success("Note added successfully")),c(""),p(null),await h(),setTimeout(g,100)}catch(e){console.error("Error saving note:",e),a.error("Failed to save note")}finally{x(!1)}}},y=e=>{c(e.content),p(e.id)},v=async e=>{if(confirm("Are you sure you want to delete this note?"))try{await d.delete(`/api/jobs/${r}/audit/${e}`),await h(),a.success("Note deleted successfully")}catch(s){console.error("Error deleting note:",s),a.error("Failed to delete note")}};return o.useEffect(()=>{h()},[r]),t.jsxs("section",{className:"bg-white border shadow rounded-lg p-6",children:[t.jsx("h2",{className:"text-xl font-semibold leading-7 text-gray-900",children:"Job Audit Log"}),t.jsx(A,{className:"my-4"}),t.jsx("div",{ref:n,className:"space-y-4 mb-4 max-h-[300px] overflow-y-auto",children:f.map(e=>{var s;return t.jsx("div",{className:"bg-gray-50 p-4 rounded-lg",children:t.jsxs("div",{className:"flex justify-between items-start",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"flex items-center gap-2",children:t.jsx("div",{className:"text-sm text-gray-900",children:e.content})}),t.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[new Date(e.created_at).toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"numeric",minute:"2-digit",hour12:!0}).replace(" pm","PM").replace(" am","AM")," by ",e.staff.name,e.updated_at!==e.created_at&&t.jsxs("span",{className:"ml-2 text-gray-400",children:["(edited ",new Date(e.updated_at).toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"numeric",minute:"2-digit",hour12:!0}).replace(" pm","PM").replace(" am","AM"),")"]})]})]}),t.jsx("div",{className:"flex gap-2 ml-4",children:e.is_system==="true"?t.jsx(C,{variant:"secondary",children:"System"}):e.staff.id===((s=u==null?void 0:u.user)==null?void 0:s.id)&&t.jsxs(t.Fragment,{children:[t.jsx(m,{variant:"ghost",size:"icon",onClick:()=>y(e),children:t.jsx(B,{className:"h-4 w-4"})}),t.jsx(m,{variant:"ghost",size:"icon",onClick:()=>v(e.id),children:t.jsx(L,{className:"h-4 w-4 text-red-500"})})]})})]})},e.id)})}),t.jsxs("div",{className:"space-y-4",children:[t.jsx(T,{placeholder:"Enter your update...",className:"min-h-[60px]",value:i,onChange:e=>c(e.target.value),rows:2}),t.jsx(m,{className:"w-full",onClick:w,disabled:j||!i.trim(),children:l?"Save Changes":"Add Note"}),l&&t.jsx(m,{variant:"outline",className:"w-full mt-2",onClick:()=>{p(null),c("")},children:"Cancel Edit"})]})]})}export{K as default};
