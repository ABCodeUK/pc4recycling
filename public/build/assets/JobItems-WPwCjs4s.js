import{r as l,R as U,j as t,b as f}from"./app-C9fBnuOE.js";import{T as L,a as M,b as I,c as S}from"./tabs-C7K6m9nX.js";import{S as z}from"./separator-qcrg4dPm.js";import{B as N}from"./button-B_fIfnBb.js";import{DataTable as B}from"./data-table-C2W8G5sW.js";import{jobItemColumns as H}from"./columns-jwwQbYAR.js";import{t as m}from"./index-BFwC0R9V.js";import V from"./CollectionSignatureDialog-BAWAbhk8.js";import"./index-Dfe5dhDQ.js";import"./index-CNTKN5Ut.js";import"./index-Ds3v4yF_.js";import"./index-CWtl1gFV.js";import"./utils-CytzSlOG.js";import"./index-CsWbMgBq.js";import"./index-BwobEAja.js";import"./table-DZdrIWYD.js";import"./select-Dl6e1rl2.js";import"./index-B-UXHqoX.js";import"./createLucideIcon-D4c-ObJW.js";import"./index-DUsJq6sw.js";import"./input-qWEfNBQH.js";import"./trash-2-nXxqySza.js";import"./extends-CF3RwP-h.js";import"./dialog-CjVGXQRN.js";import"./index-JjatSUmS.js";function Ce({jobId:a,jobStatus:_}){const[O,b]=l.useState(!1),[d,p]=l.useState(!1),[i,g]=l.useState([]),[j,J]=l.useState([]),[G,y]=l.useState(!0),[h,x]=l.useState([]),[T,v]=l.useState([]),w=async()=>{if(a){y(!0);try{const[e,s]=await Promise.all([f.get("/api/categories"),f.get(`/api/jobs/${a}/items`)]);J(e.data);const r=s.data.items.filter(o=>!o.deleted_at);g(r),v(JSON.parse(JSON.stringify(r))),x(s.data.existingItemNumbers)}catch(e){console.error("Error fetching data:",e),e instanceof Error&&"response"in e&&console.error("Server error:",e.response.data),m.error("Failed to fetch data")}finally{y(!1)}}},E=()=>{const e=i.filter(n=>n.id!==0),s=T.filter(n=>n.id!==0);if(e.length!==s.length)return!0;const r=[...e].sort((n,u)=>n.item_number.localeCompare(u.item_number)),o=[...s].sort((n,u)=>n.item_number.localeCompare(u.item_number)),C=i.some(n=>n.id===0);return JSON.stringify(r)!==JSON.stringify(o)||C},D=e=>{g(e),setTimeout(()=>{const s=E();p(s)},0)},P=e=>{const s=[],r=e.quantity,o={...e,quantity:1};s.push(o);for(let c=1;c<r;c++){const n=q(),u={...e,id:0,item_number:n,quantity:1};s.push(u),h.push(n)}const C=[...i.filter(c=>c.item_number!==e.item_number),...s];g(C),x([...h]),setTimeout(()=>{const c=E();p(c)},0)},R=()=>{const e=q(),s={id:0,job_id:0,item_number:e,quantity:1,category_id:null,sub_category_id:null,make:null,model:null,erasure_required:null,specification:null,image_path:null,processing_make:null,processing_model:null,processing_specification:null,processing_erasure_required:null,added:"Collection"};g([...i,s]),x([...h,e]),p(!0)},$=async()=>{try{const e=i.map(o=>o.item_number);if(new Set(e).size!==e.length){m.error("Duplicate item numbers found. Please ensure all item numbers are unique.");return}const r=i.map(o=>({...o,job_id:a,make:o.make||null,model:o.model||null,erasure_required:o.erasure_required||null}));console.log("Items being sent to server:",r),await f.post(`/api/jobs/${a}/items`,{items:r}),m.success("Items saved successfully"),p(!1),v(JSON.parse(JSON.stringify(i))),await w()}catch(e){console.error("Error saving items:",e),e instanceof Error&&"response"in e&&console.error("Server error:",e.response.data),m.error("Failed to save items")}},q=()=>{let e=1,s;do s=`${a}-${e.toString().padStart(2,"0")}`,e++;while(h.includes(s));return s},A=U.useMemo(()=>j,[j]);l.useEffect(()=>{a&&w()},[a]);const F=async(e,s)=>{try{const r=new FormData;r.append("customer_signature",e),r.append("driver_signature",s),await f.post(`/api/jobs/${a}/mark-collected`,r),m.success("Job marked as collected successfully"),window.location.reload()}catch(r){console.error("Error marking job as collected:",r),m.error("Failed to mark job as collected")}finally{b(!1)}},k=()=>["Needs Scheduling","Request Pending","Scheduled","Postponed"].includes(_);return t.jsxs("section",{className:"bg-white border shadow rounded-lg",children:[t.jsxs("header",{className:"p-6 flex justify-between items-center",children:[t.jsx("h2",{className:"text-lg font-semibold",children:"Collection Items"}),_==="Scheduled"&&t.jsx(N,{onClick:()=>b(!0),disabled:d,title:d?"Please save your changes first":"",children:"Mark Job Collected"})]}),t.jsx(V,{isOpen:O,onClose:()=>b(!1),onComplete:F}),t.jsx(z,{}),t.jsx("div",{className:"p-6",children:t.jsxs(L,{defaultValue:"collection",className:"w-full",children:[t.jsxs(M,{className:"grid w-full grid-cols-3",children:[t.jsx(I,{value:"collection",children:"Collection"}),t.jsx(I,{value:"processing",disabled:!0,children:"Processing"}),t.jsx(I,{value:"completed",disabled:!0,children:"Completed"})]}),t.jsxs(S,{value:"collection",className:"mt-6",children:[t.jsx(B,{columns:H,data:i,meta:{categories:A,setItems:D,onExpandItem:P,isEditable:k()}}),k()&&t.jsxs("div",{className:"flex justify-between mt-4",children:[t.jsx(N,{onClick:R,children:"Add Item"}),t.jsx(N,{onClick:$,disabled:!d,title:d?"":"No changes to save",children:"Save Changes"})]})]}),t.jsx(S,{value:"processing",children:t.jsx("p",{children:"Items in processing"})}),t.jsx(S,{value:"completed",children:t.jsx("p",{children:"Completed items"})})]})})]})}export{Ce as default};
