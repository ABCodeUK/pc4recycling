import{r as c,R as K,j as s,b as x}from"./app-CNWjOMNx.js";import{T as W,a as X,b as j,c as S}from"./tabs-plg5bBI7.js";import{S as Y}from"./separator-BPue9knr.js";import{B as p}from"./button-Cif8vmUM.js";import{DataTable as E}from"./data-table-E6iKpHjh.js";import{jobItemColumns as Z}from"./columns-Dx9S5xy2.js";import{t as m}from"./index-DROTMuiR.js";import{processingColumns as U}from"./processing-columns-CC9pGuqB.js";import"./index-D-4-NTWd.js";import"./index-DPKFiV9N.js";import"./index-DUDCROMg.js";import"./index-BqYSSVB3.js";import"./index-BJMVI5o3.js";import"./utils-CytzSlOG.js";import"./index-BHpFse_T.js";import"./index-BwobEAja.js";import"./table-B5rCecqS.js";import"./select-DyBRev3z.js";import"./index-CmDO7QdU.js";import"./index-CNsmnkFI.js";import"./createLucideIcon-ClQ1hqbp.js";import"./index-CnljWFNF.js";import"./index-BflIAMo0.js";import"./input-CKARXW-H.js";import"./maximize-2-U-dT6VrO.js";import"./trash-2-UOQr6mTH.js";function Se({jobId:a,jobStatus:i,job:ee}){const P=["Quote Requested","Quote Provided","Quote Rejected","Needs Scheduling","Request Pending","Scheduled","Postponed","Collected"],D=["Received at Facility","Processing"],C=["Complete"],T=()=>P.includes(i)?"collection":D.includes(i)?"processing":C.includes(i)?"completed":"collection",L=()=>({collection:!0,processing:!P.includes(i)||C.includes(i),completed:C.includes(i)}),[g,h]=c.useState(!1),[I,V]=c.useState(T()),[o,f]=c.useState([]),[A,z]=c.useState([]),[se,R]=c.useState(!0),[_,N]=c.useState([]),[M,k]=c.useState([]),O=L(),Q=async()=>{if(a){R(!0);try{const[e,t]=await Promise.all([x.get("/api/categories"),x.get(`/api/jobs/${a}/items`)]);z(e.data);const l=t.data.items.filter(n=>!n.deleted_at);f(l),k(JSON.parse(JSON.stringify(l))),N(t.data.existingItemNumbers)}catch(e){console.error("Error fetching data:",e),e instanceof Error&&"response"in e&&console.error("Server error:",e.response.data),m.error("Failed to fetch data")}finally{R(!1)}}},J=()=>{const e=o.filter(r=>r.id!==0),t=M.filter(r=>r.id!==0);if(e.length!==t.length)return!0;const l=[...e].sort((r,d)=>r.item_number.localeCompare(d.item_number)),n=[...t].sort((r,d)=>r.item_number.localeCompare(d.item_number)),q=o.some(r=>r.id===0);return JSON.stringify(l)!==JSON.stringify(n)||q},v=e=>{f(e),setTimeout(()=>{const t=J();h(t)},0)},w=e=>{const t=[],l=e.quantity,n={...e,quantity:1};t.push(n);for(let u=1;u<l;u++){const r=B(),d={...e,id:0,item_number:r,quantity:1};t.push(d),_.push(r)}const q=[...o.filter(u=>u.item_number!==e.item_number),...t];f(q),N([..._]),setTimeout(()=>{const u=J();h(u)},0)},$=()=>{const e=B(),t={id:0,job_id:parseInt(a),item_number:e,quantity:1,category_id:null,sub_category_id:null,make:null,model:null,serial_number:null,weight:null,asset_tag:null,image_path:null,erasure_required:null,specification:null,processing_make:null,processing_model:null,processing_serial_number:null,processing_asset_tag:null,processing_weight:null,processing_specification:null,processing_erasure_required:null,processing_data_status:null,item_status:null,added:I==="processing"?"Processing":"Collection"};f([...o,t]),N([..._,e]),h(!0)},B=()=>{let e=1,t;do t=`${a}-${e.toString().padStart(2,"0")}`,e++;while(_.includes(t));return t},F=async()=>{try{const e=o.map(n=>n.item_number);if(new Set(e).size!==e.length){m.error("Duplicate item numbers found. Please ensure all item numbers are unique.");return}const l=o.map(n=>({...n,job_id:a,added:n.added||(I==="processing"?"Processing":"Collection"),processing_data_status:n.processing_data_status||null,item_status:n.item_status||null,make:n.make||null,model:n.model||null,weight:n.weight||null,erasure_required:n.erasure_required||null}));await x.post(`/api/jobs/${a}/items`,{items:l}),m.success("Items saved successfully"),h(!1),k(JSON.parse(JSON.stringify(o))),await Q()}catch(e){console.error("Error saving items:",e),m.error("Failed to save items")}},H=async()=>{try{await x.post(`/api/jobs/${a}/accept-quote`),m.success("Quote accepted successfully!"),window.location.reload()}catch(e){console.error("Error accepting quote:",e),m.error("Failed to accept quote. Please try again.")}},y=K.useMemo(()=>A,[A]);c.useEffect(()=>{a&&Q()},[a]);const G=i==="Quote Provided",b=i==="Quote Requested";return s.jsxs("section",{className:"bg-white border shadow rounded-lg",children:[s.jsxs("header",{className:"p-6 flex justify-between items-center",children:[s.jsx("h2",{className:"text-lg font-semibold",children:"Collection Items"}),G&&s.jsx(p,{onClick:H,children:"Accept Quote"})]}),s.jsx(Y,{}),s.jsx("div",{className:"p-6",children:s.jsxs(W,{value:I,defaultValue:T(),className:"w-full",onValueChange:V,children:[s.jsxs(X,{className:"grid w-full grid-cols-3",children:[s.jsx(j,{value:"collection",children:"Collection"}),s.jsx(j,{value:"processing",disabled:!O.processing,children:"Processing"}),s.jsx(j,{value:"completed",disabled:!O.completed,children:"Completed"})]}),s.jsxs(S,{value:"collection",className:"mt-6",children:[s.jsx(E,{columns:Z,data:o.filter(e=>e.added==="Collection"&&!e.original_item_number),meta:{categories:y,setItems:v,onExpandItem:w,isEditable:b}}),b&&s.jsxs("div",{className:"flex justify-between mt-4",children:[s.jsx(p,{onClick:$,children:"Add Item"}),s.jsx(p,{onClick:F,disabled:!g,title:g?"":"No changes to save",children:"Save Changes"})]})]}),s.jsxs(S,{value:"processing",className:"mt-6",children:[s.jsx(E,{columns:U,data:o.filter(e=>["Collection","Processing"].includes(e.added||"")),meta:{categories:y,setItems:v,onExpandItem:w,isEditable:b,jobStatus:i},columnVisibility:{processing_data_status:["Processing","Completed"].includes(i)}}),b&&s.jsxs("div",{className:"flex justify-between mt-4",children:[s.jsx(p,{onClick:$,children:"Add Item"}),s.jsx(p,{onClick:F,disabled:!g,title:g?"":"No changes to save",children:"Save Changes"})]})]}),s.jsx(S,{value:"completed",className:"mt-6",children:s.jsx(E,{columns:U,data:o.filter(e=>["Collection","Processing"].includes(e.added||"")),meta:{categories:y,setItems:v,onExpandItem:w,isEditable:!1,jobStatus:i}})})]})})]})}export{Se as default};
