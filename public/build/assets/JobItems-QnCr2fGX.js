import{r as l,R as $,j as t,b as N}from"./app-BB65Mc1n.js";import{T as F,a as L,b as C,c as v}from"./tabs-D_Qtma4o.js";import{S as z}from"./separator-BWJbAkR8.js";import{B as f}from"./button-AMd0rht4.js";import{DataTable as B}from"./data-table-Lr0sWIax.js";import{jobItemColumns as H}from"./columns-Bx8iOx93.js";import{t as x}from"./index-BD8g9cTJ.js";import M from"./QuoteDialog-DrWkjDq3.js";import"./index-DJRbUwlk.js";import"./index-CwOflKzf.js";import"./index-BD0Aflgb.js";import"./index--1ygw0mz.js";import"./index-DwCxHBl2.js";import"./utils-CytzSlOG.js";import"./index-C6WAMNeG.js";import"./index-BwobEAja.js";import"./table-Baebw86p.js";import"./select-Dp5Udnaz.js";import"./index-d89-VRCp.js";import"./index-C6DuYNlM.js";import"./createLucideIcon-DhOTYlCm.js";import"./index-Bax49BpN.js";import"./index-DbDOfuCE.js";import"./input-BdsrUm4j.js";import"./maximize-2-IQ1HLsfM.js";import"./trash-2-CyBVRyGm.js";import"./dialog-44kL--cs.js";import"./label-B29Fbpt8.js";import"./textarea-DrPmTigR.js";function ve({jobId:o,jobStatus:c,job:d}){const[S,p]=l.useState(!1),[a,g]=l.useState([]),[j,T]=l.useState([]),[V,w]=l.useState(!0),[h,b]=l.useState([]),[P,_]=l.useState(!1),[R,q]=l.useState([]),y=async()=>{if(o){w(!0);try{const[e,s]=await Promise.all([N.get("/api/categories"),N.get(`/api/jobs/${o}/items`)]);T(e.data);const i=s.data.items.filter(r=>!r.deleted_at).filter(r=>r.added==="Collection"||!r.added);g(i),q(JSON.parse(JSON.stringify(i))),b(s.data.existingItemNumbers)}catch(e){console.error("Error fetching data:",e),e instanceof Error&&"response"in e&&console.error("Server error:",e.response.data),x.error("Failed to fetch data")}finally{w(!1)}}},E=()=>{const e=a.filter(n=>n.id!==0),s=R.filter(n=>n.id!==0);if(e.length!==s.length)return!0;const i=[...e].sort((n,u)=>n.item_number.localeCompare(u.item_number)),r=[...s].sort((n,u)=>n.item_number.localeCompare(u.item_number)),I=a.some(n=>n.id===0);return JSON.stringify(i)!==JSON.stringify(r)||I},k=e=>{g(e),setTimeout(()=>{const s=E();p(s)},0)},D=e=>{const s=[],i=e.quantity,r={...e,quantity:1};s.push(r);for(let m=1;m<i;m++){const n=O(),u={...e,id:0,item_number:n,quantity:1};s.push(u),h.push(n)}const I=[...a.filter(m=>m.item_number!==e.item_number),...s];g(I),b([...h]),setTimeout(()=>{const m=E();p(m)},0)},J=()=>{const e=O(),s={id:0,job_id:0,item_number:e,quantity:1,category_id:null,sub_category_id:null,make:null,model:null,serial_number:null,asset_tag:null,weight:null,erasure_required:null,specification:null,image_path:null,processing_make:null,processing_model:null,processing_serial_number:null,processing_weight:null,processing_asset_tag:null,processing_specification:null,processing_erasure_required:null,added:"Collection"};g([...a,s]),b([...h,e]),p(!0)},A=async()=>{try{const e=a.map(r=>r.item_number);if(new Set(e).size!==e.length){x.error("Duplicate item numbers found. Please ensure all item numbers are unique.");return}const i=a.map(r=>({...r,job_id:o,make:r.make||null,model:r.model||null,erasure_required:r.erasure_required||null}));console.log("Items being sent to server:",i),await N.post(`/api/jobs/${o}/items`,{items:i}),x.success("Items saved successfully"),p(!1),q(JSON.parse(JSON.stringify(a))),await y()}catch(e){console.error("Error saving items:",e),e instanceof Error&&"response"in e&&console.error("Server error:",e.response.data),x.error("Failed to save items")}},O=()=>{let e=1,s;do s=`${o}-${e.toString().padStart(2,"0")}`,e++;while(h.includes(s));return s},U=$.useMemo(()=>j,[j]);l.useEffect(()=>{o&&y()},[o]);const Q=()=>["Quote Requested","Needs Scheduling","Request Pending","Scheduled","Postponed"].includes(c);return t.jsxs(t.Fragment,{children:[t.jsxs("section",{className:"bg-white border shadow rounded-lg",children:[t.jsxs("header",{className:"p-6 flex justify-between items-center",children:[t.jsx("h2",{className:"text-lg font-semibold",children:"Items to collect"}),(c==="Quote Requested"||c==="Quote Rejected")&&t.jsx(f,{onClick:()=>_(!0),children:"Provide Quote"}),(c==="Quote Provided"||c==="Quote Declined")&&t.jsx(f,{onClick:()=>{_(!0)},children:"Adjust Quote"})]}),t.jsx(z,{}),t.jsx("div",{className:"p-6",children:t.jsxs(F,{defaultValue:"collection",className:"w-full",children:[t.jsxs(L,{className:"grid w-full grid-cols-3",children:[t.jsx(C,{value:"collection",children:"Collection"}),t.jsx(C,{value:"processing",disabled:!0,children:"Processing"}),t.jsx(C,{value:"completed",disabled:!0,children:"Completed"})]}),t.jsxs(v,{value:"collection",className:"mt-6",children:[t.jsx(B,{columns:H,data:a,meta:{categories:U,setItems:k,onExpandItem:D,isEditable:Q()}}),Q()&&t.jsxs("div",{className:"flex justify-between mt-4",children:[t.jsx(f,{onClick:J,children:"Add Item"}),t.jsx(f,{onClick:A,disabled:!S,title:S?"":"No changes to save",children:"Save Items"})]})]}),t.jsx(v,{value:"processing",children:t.jsx("p",{children:"Items in processing"})}),t.jsx(v,{value:"completed",children:t.jsx("p",{children:"Completed items"})})]})})]}),t.jsx(M,{isOpen:P,onClose:()=>_(!1),jobId:o,initialData:d&&{job_quote:d.job_quote,collection_date:d.collection_date,quote_information:d.quote_information}})]})}export{ve as default};
